<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title data-translate="my_reservations_title">My Reservations</title>
    <link href="/css/styles.css" rel="stylesheet">
    <script>
        function toggleEditForm(id) {
            const form = document.getElementById(`edit-form-${id}`);
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        async function handleReservationAction(id, action) {
            const confirmed = action === 'DELETE'
                ? confirm("Are you sure you want to cancel this reservation?")
                : true;

            if (!confirmed) return;

            const url = `/customer/reservations/${id}`;
            const method = action === 'DELETE' ? 'DELETE' : 'PUT';
            const body = action === 'PUT' ? JSON.stringify(getFormData(id)) : null;

            const response = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body
            });

            if (response.ok) {
                alert(action === 'DELETE' ? "Reservation deleted" : "Reservation updated");
                location.reload();
            } else {
                const error = await response.text();
                alert(`Error: ${error}`);
            }
        }

        function getFormData(id) {
            const form = document.getElementById(`edit-form-${id}`);
            return {
                date: form.querySelector('[name="date"]').value,
                hour: form.querySelector('[name="hour"]').value,
                nPeople: form.querySelector('[name="nPeople"]').value
            };
        }
    </script>
    <script th:if="${currentUser != null}" th:inline="javascript">
        const CURRENT_USER_ID = [[${currentUser.id}]];
    </script>
    <script th:if="${currentUser == null}" th:inline="javascript">
        const CURRENT_USER_ID = null;
    </script>
</head>
<body data-page="customer">
    <div class="auth-box">
        <h2 data-translate="my_reservations_heading">My Reservations</h2>

        <div th:if="${param.success}" class="success-message">
            <p data-translate="reservation_created_success">Reservation successfully created!</p>
        </div>

        <div th:if="${reservations.empty}">
            <p data-translate="no_reservations_message">You don't have any reservations yet.</p>
        </div>

        <div th:unless="${reservations.empty}">
            <div class="reservation-list">
                <div class="reservation-card" th:each="reservation : ${reservations}">
                    <h3 data-translate="reservation_number">Reservation #<span th:text="${reservation.reservationId}"></span></h3>
                    <p data-translate="reservation_date">Date: <span th:text="${reservation.date}"></span></p>
                    <p data-translate="reservation_time">Time: <span th:text="${reservation.hour}"></span></p>
                    <p data-translate="reservation_people">People: <span th:text="${reservation.nPeople}"></span></p>
                    <p data-translate="reservation_status">Status: <span th:text="${reservation.state}"></span></p>

                    <button class="btn small" th:onclick="'toggleEditForm(' + ${reservation.reservationId} + ')'" data-translate="edit_button">Edit</button>
                    <button class="btn small danger" th:onclick="'handleReservationAction(' + ${reservation.reservationId} + ', \'DELETE\')'" data-translate="cancel_button">Cancel</button>
                    <th:block th:if="${reservation.state.equals('completed')} and ${reservation.review} == null">
                        <button class="btn small" th:attr="onclick=|toggleReviewForm(${reservation.reservationId})|" data-translate="review_button">Review</button>
                    </th:block>
                </div>
            </div>
        </div>

        <div class="auth-links">
            <a href="/customer/new-reservation" class="btn primary" data-translate="new_reservation_button">New Reservation</a>
            <a href="/customer/home" data-translate="back_to_home">‚Üê Back to home</a>
        </div>
    </div>

    <script src="/js/translation.js"></script>
</body>
</html>